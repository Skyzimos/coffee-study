<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Preferences Statistics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }

        canvas {
            max-width: 600px;
            margin: 20px auto;
        }
    </style>
</head>

<body>
    <h1>Coffee Preferences Statistics</h1>
    <h2 id="respondentCount">Loading...</h2>
    <p>
        This is an ongoing study, conducted for the purpose of finding out which
        coffee shop different Sexual Orientations generally lean towards.
        <br><br><i><u><b>Note:</b></u></i> For the purposes of this study, the "Other" category under Sexual Orientation includes individuals who do not identify as "Straight",<br>but may not specifically identify with the other listed Sexual Orientations. This includes a diverse list of identities,<br>including, but not limited to, Bisexual, Pansexual, Asexual, among others.
    </p>
    <canvas id="coffeeChart"></canvas>
    <canvas id="genderChart"></canvas>
    <canvas id="orientationChart"></canvas>
    <canvas id="starbucksOrientationChart"></canvas>
    <canvas id="caribouOrientationChart"></canvas>

    <script>
        (function () {
            const sheetURL = "https://script.google.com/macros/s/AKfycby2zr3CcH42xW0dyEAawpO09UK_2wjzP0yUKcBhLKUqq7Xe-gMSzhdyrUPTd0M9kzx7Qw/exec"; // Your Apps Script URL

            async function fetchData() {
                try {
                    const response = await fetch(sheetURL);
                    const data = await response.json();
                    console.log(data)
                    processData(data);
                } catch (error) {
                    console.error("Error fetching data:", error);
                }
            }

            function countByCategory(data, category) {
                return data.reduce((acc, item) => {
                    acc[item[category]] = (acc[item[category]] || 0) + 1;
                    return acc;
                }, {});
            }

            function countOrientationByCoffee(data, coffeeType) {
                return data.reduce((acc, item) => {
                    if (item.coffee === coffeeType) {
                        acc[item.orientation] = (acc[item.orientation] || 0) + 1;
                    }
                    return acc;
                }, {});
            }

            function createChart(chartId, label, dataObj) {
                new Chart(document.getElementById(chartId), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(dataObj),
                        datasets: [{
                            label: label,
                            data: Object.values(dataObj),
                            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
                        }]
                    }
                });
            }

            function processData(coffeeData) {
                const respondentCountElement = document.getElementById("respondentCount");
                const currentDate = new Date().toLocaleDateString("en-US", {
                    year: "numeric",
                    month: "long",
                    day: "numeric"
                });

                respondentCountElement.innerText = `${coffeeData.length} Respondents (as of ${currentDate})`;

                createChart("coffeeChart", "Coffee Preferences (by Study Participants)", countByCategory(coffeeData, "coffee"));
                createChart("genderChart", "Gender Distribution (by Study Participants)", countByCategory(coffeeData, "gender"));
                createChart("orientationChart", "Orientation Distribution (by Study Participants)", countByCategory(coffeeData, "orientation"));
                createChart("starbucksOrientationChart", "Starbucks Visitors (by Orientation)", countOrientationByCoffee(coffeeData, "Starbucks"));
                createChart("caribouOrientationChart", "Caribou Coffee Visitors (by Orientation)", countOrientationByCoffee(coffeeData, "Caribou Coffee"));
            }

            document.addEventListener("DOMContentLoaded", () => {
                fetchData();
                setInterval(() => {
                    fetchData();
                }, 300000);
            });
        })();
    </script>
</body>

</html>